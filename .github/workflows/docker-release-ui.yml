name: Build and Push Harmony Speech Engine UI Docker Image

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for the build'
        default: 'v0.0.0-dev'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set VERSION variable
        shell: pwsh
        run: |
          $inputsVersion = '${{ github.event.inputs.version }}'
          if ($env:GITHUB_REF -like 'refs/tags/*') {
            $env:VERSION = $env:GITHUB_REF -replace 'refs/tags/', ''
          } elseif ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch' -and $inputsVersion -ne '') {
            $env:VERSION = $inputsVersion
          } else {
            $env:VERSION = 'v0.0.0-dev'
          }
          echo "VERSION=$env:VERSION" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Determine Frontend Reference
        shell: pwsh
        run: |
          try {
            $response = Invoke-WebRequest -Uri "https://api.github.com/repos/harmony-ai-solutions/harmony-link-ui/git/refs/tags/$env:VERSION" -Method Head -ErrorAction Stop
            Write-Host "Frontend tag $env:VERSION found, using tag"
            echo "FRONTEND_REF=$env:VERSION" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } catch {
            Write-Host "Frontend tag $env:VERSION not found, using main branch"
            echo "FRONTEND_REF=main" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: Checkout Frontend UI Source
        shell: pwsh
        run: |
          Write-Host "Preparing frontend source from harmony-link-ui at ref: $env:FRONTEND_REF"
          if (Test-Path frontend) {
            Remove-Item -Recurse -Force frontend
          }
          git clone --depth 1 --branch $env:FRONTEND_REF https://github.com/harmony-ai-solutions/harmony-link-ui.git frontend
          Write-Host "Frontend source checkout complete."

      - name: Log selected frontend ref and Dockerfile
        shell: pwsh
        run: |
          Write-Host "Using FRONTEND_REF=$env:FRONTEND_REF"
          Write-Host "Using Dockerfile=./frontend/Dockerfile.speech-engine"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker registry
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build and push harmonyspeech-ui image
        uses: docker/build-push-action@v3
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.speech-engine
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/harmonyspeech-ui:${{ env.VERSION }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/harmonyspeech-ui:latest
